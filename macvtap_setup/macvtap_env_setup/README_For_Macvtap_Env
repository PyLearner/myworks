##################                           ##################
#                # eno4                 eno4 #                #
#      HOST      #---------------------------#     Gateway    #
#                #                           #                #
##################                           ##################




# In Host,just configure The static Ip address for eno4,and then start the interface

# In Gateway:
# 1. Configure Ip address for eno4,and then start the interface
# 2. Configure Dhcp using libvirt dnsmasq,
# 3. Configure Iptables,then reload it.
# 4. Open the forward function



The following iptables commands can be generated using "service iptables save",
in default ,the input/output port will be virbr0,you just need to modify it to the proper port,and in my env,it is eno4

--------------------------------------------------------------------------

# Generated by iptables-save v1.4.21 on Thu Mar 26 18:56:49 2015
*filter
:INPUT ACCEPT [112:9157]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [61:6968]
-A INPUT -i eno4 -p udp -m udp --dport 53 -j ACCEPT
-A INPUT -i eno4 -p tcp -m tcp --dport 53 -j ACCEPT
-A INPUT -i eno4 -p udp -m udp --dport 67 -j ACCEPT
-A INPUT -i eno4 -p tcp -m tcp --dport 67 -j ACCEPT
-A FORWARD -d 192.168.122.0/24 -o eno4 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -s 192.168.122.0/24 -i eno4 -j ACCEPT
-A FORWARD -i eno4 -o eno4 -j ACCEPT
-A FORWARD -o eno4 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -i eno4 -j REJECT --reject-with icmp-port-unreachable
-A OUTPUT -o eno4 -p udp -m udp --dport 68 -j ACCEPT
COMMIT
# Completed on Thu Mar 26 18:56:49 2015
# Generated by iptables-save v1.4.21 on Thu Mar 26 18:56:49 2015
*nat
:PREROUTING ACCEPT [1:229]
:INPUT ACCEPT [1:229]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING -s 192.168.122.0/24 -d 224.0.0.0/24 -j RETURN
-A POSTROUTING -s 192.168.122.0/24 -d 255.255.255.255/32 -j RETURN
-A POSTROUTING -s 192.168.122.0/24 ! -d 192.168.122.0/24 -p tcp -j MASQUERADE --to-ports 1024-65535
-A POSTROUTING -s 192.168.122.0/24 ! -d 192.168.122.0/24 -p udp -j MASQUERADE --to-ports 1024-65535
-A POSTROUTING -s 192.168.122.0/24 ! -d 192.168.122.0/24 -j MASQUERADE
COMMIT
# Completed on Thu Mar 26 18:56:49 2015
# Generated by iptables-save v1.4.21 on Thu Mar 26 18:56:49 2015
*mangle
:PREROUTING ACCEPT [112:9157]
:INPUT ACCEPT [112:9157]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [61:6968]
:POSTROUTING ACCEPT [61:6968]
-A POSTROUTING -o eno4 -p udp -m udp --dport 68 -j CHECKSUM --checksum-fill
COMMIT
# Completed on Thu Mar 26 18:56:49 2015

--------------------------------------------------------------------------



# for the macvtap-dnsmasq.conf,you just need to change the option "dhcp-range" to your ip range if you would like,
otherwise,just leave it default.

mavtap-dnsmasq.conf

##WARNING:  THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
##OVERWRITTEN AND LOST.  Changes to this configuration should be made using:
##    virsh net-edit default
## or other application using the libvirt API.
##
## dnsmasq conf file created by libvirt
strict-order
pid-file=/var/run/macvtap.pid
except-interface=lo
bind-dynamic
interface=eno4
dhcp-range=192.168.122.2,192.168.122.254
dhcp-no-override
dhcp-leasefile=/var/run/macvtap/dnsmasq/default.leases
dhcp-lease-max=253
dhcp-hostsfile=/var/run/macvtap/dnsmasq/default.hostsfile
addn-hosts=/var/run/macvtap/dnsmasq/default.addnhosts



#set up the env using the script.

besides configure it manually,you can use the script "macvtap_env_setup.py" and the cfg "gateway-iptables" to set up
the macvtap enviroment automatically, it is easy to use, just copy the 2 files to your dir ,run it according to the instructions.

# Note:
# 1. Please Install the python package pexpect before your run.
# 2. The parameters is hardcoded and only applies to the 2 machines,if the port changes,you
#    should modify it before run.so please do check before running.

# How to run:
# 1.There are 2 files, macvtap_env_setup.py and gateway-iptables
# 2.Copy them to your dir and just run python macvtap_env_setup.py








README
============================================================

How to test macvtap in autotest ?

Requried package:
    iptables-services

Required HW:
    at least, two host and ensure each host have two linked nics,
and one nic connected to virtlab public network envrioment, another
nic connect two switch support macvtap.

Network configuration:
    when mavtap works under vepa mode, host can not communicate with
guest via local network, so we need another host works like gateway
to support communication between host and guest;

    example network configuration:

        Host A (works like a gateway):
           switch(10.66.106.xxx) --> virtlab
           eno4  (192.168.10.1) --> macvtap switch

        Host B (testbox):
           eno1 (10.66.106.xxx) --> virtlab
           eno4 (192.168.10.2) --> macvtap switch

In order to keep guest communicate with virtlab network, we still need
setup a NAT envrioment in refer host(Host A). And I have a copy iptables.
you can copy it to Host A, then restart iptables service to load it.

scp iptables root@HostA:/etc/sysconfig/iptables
service iptables restart

And, a dhcp service should works in a port of  macvtap switch, we can
to dnsmasq tool to do it. we can do it by below command:
make directorys on HostA.
mkdir -p /var/run/macvtap
scp macvtap-dnsmasq.conf  root@HostA:/var/run/macvtap/dnsmasq.conf
then, start dnsmasq in hostA by command:
/sbin/dnsmasq --conf-file=/var/run/macvtap/dnsmasq.conf --dhcp-script=/usr/libexec/libvirt_leaseshelper

Check Network envrioment:
ping 192.168.10.1 from 192.168.10.2 to ensure network is reachable. if not, please
run clean iptables on 192.168.10.2 by command:
iptables -F;iptables -Z; iptables -X
then, try again.

Run test case in autotest under mavtap env:

   Get autotest and staf code to  HostB, if you use staf, please use options
  --nettype=mavtap  --netdst=eno4
  else please ensure your tests-example.cfg has lines:
  "nettype=macvtap", "netdst=eno4"
